<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VoicePOC</title>

    <script>
        window.onload = function () {

            const targetSentence = "once there was a tiny little robot";
            let targetWords = targetSentence.toLowerCase().split(' ');



            let targetIndex = 0;
            let grammar = '#JSGF V1.0; grammar words; public <word> = ' + targetWords.join(' | ') + ' ;'
            console.log(grammar);
            let recognition = new webkitSpeechRecognition();
            let speechRecognitionList = new webkitSpeechGrammarList();
            speechRecognitionList.addFromString(grammar, 1);
            recognition.grammars = speechRecognitionList;
            recognition.continuous = true;
            recognition.lang = 'en-US';
            recognition.interimResults = true;
            recognition.maxAlternatives = 1;

            let diagnostic = document.querySelector('.output');
            let status = document.querySelector('.status');
            let markup = targetWords.map(word => `<span style="">${word} </span>`).join('');
            diagnostic.innerHTML = markup;
            let bg = document.querySelector('html');

            document.body.onclick = function () {
                diagnostic.innerHTML = markup;
                status.textContent = "listening..."
                recognition.start();
                targetIndex = 0;
                console.log('Ready to receive a voice input.');
            }

            recognition.onspeechend = function() {
                console.log("speechend");
                // recognition.stop();
            }

            recognition.onend = function() {
                console.log("end");
                recognition.stop();
                if(targetIndex < targetWords.length){
                    console.log("restarting");
                    recognition.start();
                }
            }

            recognition.onresult = function (event) {
                let transcript = '',
                    isFinal = false;

                console.log(event);
                let targetWord = targetWords[targetIndex];
                console.log("target", targetWord);

                for(let result=event.resultIndex, wordFound = false;result<event.results.length && !wordFound ;result++){
                    console.log(`result ${result}`)
                    for(let alternative=0;alternative<event.results[0].length && !wordFound ;alternative++){
                        console.log(`alt ${alternative}`)
                        if(!(event.results[result] && event.results[result][alternative])){
                            break;
                        }
                        transcript = event.results[result][alternative].transcript.toLowerCase();
                        isFinal = event.results[result].isFinal;

                        console.log("transcript", transcript);
                        if(transcript.includes(targetWord)){
                            let transcriptWords = transcript.split(' ');
                            let transcriptIndex = 0;

                            console.log("transcriptWords", transcriptWords);

                            while(!transcriptWords[transcriptIndex] && transcriptIndex < transcriptWords.length){
                                transcriptIndex++;
                                console.log('found empty string');
                            }
                            while(!wordFound && targetIndex < targetWords.length && transcriptIndex < transcriptWords.length){
                                console.log(`target ${targetIndex} trans ${transcriptIndex}`)
                                if(transcriptWords[transcriptIndex] == targetWords[targetIndex]){
                                    diagnostic.childNodes[targetIndex].style.color = 'red';
                                    targetIndex++;
                                    wordFound=true;
                                }
                                transcriptIndex++;
                            }

                            if(targetIndex >= targetWords.length){
                                console.log("done");
                                status.textContent = "Click anywhere to begin.";
                                recognition.abort();
                            }
                        }
                    }
                }
            }
        }

    </script>

</head>
<body style="width:100%; height:800px">

</body>
<div class="status">Click anywhere to begin.</div>
<div class="output"></div>
</html>